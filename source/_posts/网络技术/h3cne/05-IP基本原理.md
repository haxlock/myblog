---
title: IP基本原理
date: 2025/3/29
tags: 网络技术
categories: 

- [网络技术]
---

# IP基本原理
<!-- more -->
## IP及其相关协议

## ip的主要作用

### 标识节点和链路

- 用唯一的ip地址标识每一个节点

- 用唯一的ip网络号标识每一个链路（网段/范围）

### 寻址和转发

- 确认节点所在网络位置，进而确定节点所在的位置

- IP路由器选择适当的路径把IP包转发到目的节点

### 适应各种数据链路

- 根据链路的MTU对IP包进行分片和重组

- 为了通过实际的数据链路传递信息，需建立IP

## IP头部封装格式

### Version

4和6,代表ipv4和ipv6

### IHL

头部长度

长度是20-60字节

原因：头部是20字节，后面可选项是0-40字节不等，因此是20-60字节

要明确说明头部长度，这样才能知道那边是ip头部，哪边是tcp头部

### Type of Service

QoS 流量控制，那些数据包优先转发，优先级越高，越优先转发

### Total Length

总长度：`IP头长度`加上`数据包长度`的总长度

### Identification（标识符）

数据包分片

为了区分分片的数据都来源于那边

例如有一个2000Byte的数据包

分片成四个500Byte的数据包

加一个标识符，1.1，1.2，1.3，1.4...来告知这个分片来自于`1`数据包

### Flags（标志位）

只有0/1

代表某个功能是否开启

- 保留

- 表示数据包是否禁止分片

- 标识是否为最后一个数据分片

### Fragmenf Offset（片偏移）

分片偏移

用于描述分片在数据包的位置

防止分片会因为接收方的先后顺序，导致数据包错误

### Time to Live(TTL)

生存时间

- 改数据包允许经过的路由器的最大跳数

- 每经过一个路由器，TTL做-1处理

### Protocol

用于描述上层协议

描述上层传输层的协议是tcp还是udp

### Header Checksum(校验序列)

数据包头部会有一个hash校验码，做差错校验，防止数据包数据不准确的问题

### Source Address

源地址

### Destination Address

目的地址

### Option

可选项

### Padding

填充

## MTU

- 最大传输单元

- 接口收发数据支持的单个包的最大长度

- 以太网接口默认是1500Byte

- PPPoE默认是MTY1492Byte

例如：当一口是以太网口，一口是1492Byte，那么1500Byte数据包就不能一次性发送，需要分片数据包，两个750Byte就可以传输数据了

## IP地址和ip映射

### 定义

网络层地址

### 格式

- 32位长度，点分十进制

- 由网络位和主机位组成

- 网络为长度和数字完全一致的地址属于同一网段

### 分类

#### A

- 范围：1.x.x.x-126.x.x.x

- 网络为划分：前八位是网络位，后24位是主机位

#### B

- 范围：127.x.x.x-191.x.x.x

- 划分：前16位置是网络位，后16位是主机位

#### C

- 范围：192.x.x.x-223.x.x.x

- 划分：前24位是网络位，后8位是主机位

#### D

- 范围：224.X.X.X-239.X.X.X

- 作用：组播地址，不可用于配置为主机地址

#### E

- 范围：240.X.X.X-255.X.X.X

- 作用：科研类地址

#### IP地址是用来划分不同的网络规模的

#### 特殊地址：

- 127.0.0.1：本地环回地址

- 255.255.255.255：广播地址

- 主机位全是0的地址：网络地址，用来标识某个网段。例如：192.168.1.0

- 主机位全是1的地址：本网段的广播地址，例如：192.168.1.255

- 0.0.0.0：任意ip地址

> 广播就是一个人发给所有人
> 
> 例如给192.168.1.255发数据后，**本网段**下所有的计算机都能收到这个信息

## ARP协议

### 定义

地址解析协议，把IP地址解析为Mac地址

### 工作原理

- A主机以广播形式发送ARP请求，询问B主机的IP对应的MAC地址

- B主机以单薄形式回复A主机本机MAC地址

- A主机把B主机的IP地址和MAC地址的映射关系写入ARP缓存表 

## RARP(逆向ARP)

- 逆向地址解析协议

- 用于根据本机自己的MAC地址，查询本机自己的IP地址

## ICMP协议

### Ping

用于测试网络连通性

### traceroute

- 路由跟踪

- 华三设备的开启路由跟踪功能需要的前置命令：

- - ip ttl-expires enable
  
  - ip unreachables enable

## IP数据转发原理

- 如果目的ip和本机ip属于同一网段，会直接查询目的ip的mac地址，并进行封装

- 如果不属于同一网段，会查询网关ip的mac地址，并进行封装

## 网关

- Gateway

- 本网段出口的IP地址

解释：

比方说在一个路由器下两台交换机，交换机下有pc

那么，假设路由器上接口上ip是1.254和2.254，例如逆向从1.1的一个pc发消息给2.1上面，那么信息得先要发到1.254这个网管上，然后再转到2.254上，才能最后转到2.1上，这就是网关的作用，他就是一扇门，用来控制你数据包的出入。
